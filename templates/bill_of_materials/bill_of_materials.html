{% extends "module_template_html/base_template.html" %}

{% block title %}Bill of Materials{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search_bill_of_material.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bill_of_materials.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
    <!-- Search BOM - available to LEVEL_I and above -->
    {% if session['user_level'] == 'LEVEL_I' or session['user_level'] == 'LEVEL_II' or session['user_level'] == 'LEVEL_III' or session['user_level'] == 'ADMIN' %}
    <div id="search-bill-of-materials" class="form-container">
        <h1>Parts Search By Used On</h1>
        <!-- Button to toggle the collapsible form -->
        <button type="button" id="toggleFormBtn" style="background-color: #007bff; color: #fff; padding: 10px 20px;">
            Toggle Advanced Search (Area, Equipment Group, Model)
        </button>
        <!-- Collapsible Form: Advanced Search -->
        <div id="advancedSearchForm" style="display: none; margin-top: 15px;">
            <form method="POST" action="{{ url_for('create_bill_of_material_bp.create_bill_of_material') }}">
                <div style="margin-bottom: 15px;">
                    <label for="filter_areaDropdown" style="color: Yellow;">Area:</label>
                    <select name="area" id="filter_areaDropdown" style="width: 100%; max-width: 600px;"></select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="filter_equipmentGroupDropdown" style="color: Yellow;">Equipment Group:</label>
                    <select name="equipment_group" id="filter_equipmentGroupDropdown" style="width: 100%; max-width: 600px;"></select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="filter_modelDropdown" style="color: Yellow;">Model:</label>
                    <select name="model" id="filter_modelDropdown" style="width: 100%; max-width: 600px;"></select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="filter_assetNumberDropdown" style="color: Yellow;">Asset Number:</label>
                    <select name="asset_number" id="filter_assetNumberDropdown" style="width: 100%; max-width: 600px;"></select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="filter_locationDropdown" style="color: Yellow;">Location:</label>
                    <select name="location" id="filter_locationDropdown" style="width: 100%; max-width: 600px;"></select>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="submit" value="Filter" style="background-color: #007bff; color: #fff; padding: 10px 20px;">
                </div>
            </form>
        </div>

        <!-- General Search Box -->
        <div id="generalSearch" style="margin-top: 30px;">
            <h3>Quick Search by Asset Number or Location</h3>
            <form method="POST" action="{{ url_for('create_bill_of_material_bp.bom_general_search') }}">
                <div style="margin-bottom: 15px;">
                    <label for="general_assetNumber" style="color: Yellow;">Asset Number:</label>
                    <input type="text" id="general_assetNumber" name="general_asset_number" placeholder="Type Asset Number" style="width: 100%; max-width: 600px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="general_location" style="color: Yellow;">Location:</label>
                    <input type="text" id="general_location" name="general_location" placeholder="Type Location" style="width: 100%; max-width: 600px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="submit" value="Search" style="background-color: #007bff; color: #fff; padding: 10px 20px;">
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Upload Bill of Materials Form - restricted to LEVEL_III and ADMIN -->
    {% if session['user_level'] == 'LEVEL_III' or session['user_level'] == 'ADMIN' %}
    <div id="upload-bill-of-materials" class="form-container">
        <h2>Upload Bill of Materials</h2>
        <form id="upload-bom-form" action="/bill_of_materials" method="post" enctype="multipart/form-data">
            <label for="area" style="color: Yellow;">Area:</label>
            <select name="area" id="bom_areaDropdown"></select><br>
            <label for="equipment_group" style="color: Yellow;">Equipment Group:</label>
            <select name="equipment_group" id="bom_equipmentGroupDropdown"></select><br>
            <label for="model" style="color: Yellow;">Model:</label>
            <select name="model" id="bom_modelDropdown"></select><br>
            <label for="asset_number" style="color: Yellow;">Asset Number:</label>
            <select name="asset_number" id="bom_assetNumberDropdown"></select><br>
            <label for="location" style="color: Yellow;">Location:</label>
            <select name="location" id="bom_locationDropdown"></select><br>
            <label for="image_path" style="color: Yellow;">Image Path:</label>
            <input type="text" name="image_path" id="image_path"><br>
            <input type="file" name="file" required><br>
            <input type="submit" value="Upload">
        </form>
    </div>
    {% endif %}

    <!-- Enter New Part Form - restricted to LEVEL_II and above -->
    {% if session['user_level'] == 'LEVEL_II' or session['user_level'] == 'LEVEL_III' or session['user_level'] == 'ADMIN' %}
    <div id="1enter-new-part-number" class="form-container">
        {% include 'bill_of_materials/bom_partials/enter_new_part.html' %}
    </div>
    {% endif %}

    <!-- Search and Edit Part Form - available to LEVEL_I and above -->
    {% if session['user_level'] == 'LEVEL_I' or session['user_level'] == 'LEVEL_II' or session['user_level'] == 'LEVEL_III' or session['user_level'] == 'ADMIN' %}
    <div id="edit-part" class="form-container">
        <h1>Search and Edit Part</h1>

        <!-- Search form for finding a part -->
        <form action="{{ url_for('update_part_bp.search_part') }}" method="GET">
            <label for="search_query">Search by Part Number, Name, OEM Manufacturer, or Model:</label>
            <input type="text" id="search_query" name="search_query" placeholder="Type your search here..." required><br>
            <input type="submit" value="Search">
        </form>

        <!-- Display part options if search results are available -->
        {% if parts %}
        <form action="{{ url_for('update_part_bp.edit_part') }}" method="POST">
            <label for="part_id">Select Part to Edit:</label>
            <select name="part_id" id="part_id" required>
                {% for part in parts %}
                    <option value="{{ part.id }}">{{ part.part_number }} - {{ part.name }} ({{ part.oem_mfg }})</option>
                {% endfor %}
            </select><br>
            <input type="submit" value="Edit Selected Part">
        </form>
        {% endif %}

        <!-- Include the edit part form partial -->
        {% include 'bill_of_materials/bom_partials/enter_new_part.html' %}
    </div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="margin-top: 20px; padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;">
                <ul>
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}
    {% endwith %}
{% endblock %}

{% block sidebar %}
    {% with current_page = 'bom' %}
        {% include 'module_template_html/base_sidebar.html' %}
    {% endwith %}
{% endblock %}

{% block extra_scripts %}
    <script>
        // Show specific form based on the formId and hide the others
        function showForm(formId) {
            // Check user permissions before showing form
            {% if session['user_level'] == 'STANDARD' %}
                // No access for STANDARD users
                alert("You don't have permission to access this feature.");
                return;
            {% else %}
                // Check specific permissions
                {% if session['user_level'] == 'LEVEL_I' %}
                    // LEVEL_I can only access search and edit
                    if (formId === 'upload-bill-of-materials' || formId === '1enter-new-part-number') {
                        alert("You don't have permission to access this feature.");
                        return;
                    }
                {% elif session['user_level'] == 'LEVEL_II' %}
                    // LEVEL_II can't access upload
                    if (formId === 'upload-bill-of-materials') {
                        alert("You don't have permission to access this feature.");
                        return;
                    }
                {% endif %}
            {% endif %}

            var forms = document.getElementsByClassName('form-container');
            for (var i = 0; i < forms.length; i++) {
                forms[i].style.display = 'none';  // Hide all forms
            }

            var targetForm = document.getElementById(formId);
            if (targetForm) {
                targetForm.style.display = 'block';  // Show the selected form
            } else {
                console.error('Form not found:', formId);
            }
        }

        // Toggle visibility of advanced search form
        function toggleAdvancedSearch() {
            var advancedForm = document.getElementById('advancedSearchForm');
            if (advancedForm.style.display === "none" || advancedForm.style.display === "") {
                advancedForm.style.display = "block";
            } else {
                advancedForm.style.display = "none";
            }
        }

        // Event listeners after DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Hide all forms initially
            var forms = document.getElementsByClassName('form-container');
            for (var i = 0; i < forms.length; i++) {
                forms[i].style.display = 'none';
            }

            // Show default form based on user level
            {% if session['user_level'] == 'LEVEL_I' or session['user_level'] == 'LEVEL_II' or session['user_level'] == 'LEVEL_III' or session['user_level'] == 'ADMIN' %}
                document.getElementById('search-bill-of-materials').style.display = 'block'; // Default form
            {% endif %}

            // Event listener for the advanced search toggle button
            var toggleButton = document.getElementById('toggleFormBtn');
            if (toggleButton) {
                toggleButton.addEventListener('click', toggleAdvancedSearch);
            }
        });

        // Listener for hash changes (to show the correct form based on URL hash)
        window.addEventListener('hashchange', function() {
            var hash = window.location.hash.substring(1); // Remove '#' symbol
            if (hash) {
                showForm(hash);  // Show form based on hash in URL
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/get_bill_of_material_query.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bill_of_materials.js') }}"></script>
{% endblock %}