{% extends "base.html" %}

{% macro render_field_with_toggle(field, input_field, label_text, placeholder_text) %}
  <div class="form-group" id="{{ field.name }}_group">
      <label class="form-label">{{ label_text }}</label>
      <div class="existing-entry" id="{{ field.name }}_existing">
          {{ field(class="form-control") }}
          {% for error in field.errors %}
              <span class="text-danger">{{ error }}</span>
          {% endfor %}
          <small>
              <a href="javascript:void(0)" onclick="toggleNewEntry('{{ field.name }}')">
                  Add new {{ label_text }}
              </a>
          </small>
      </div>
      <div class="new-entry" id="{{ field.name }}_new" style="display: none;">
          {{ input_field(class="form-control", placeholder=placeholder_text) }}
          {% for error in input_field.errors %}
              <span class="text-danger">{{ error }}</span>
          {% endfor %}
          <small>
              <a href="javascript:void(0)" onclick="toggleNewEntry('{{ field.name }}')">
                  Cancel
              </a>
          </small>
      </div>
  </div>
{% endmacro %}

{% macro render_field_with_toggle_and_description(field, input_field, desc_field, label_text, placeholder_text, desc_placeholder) %}
  <div class="form-group" id="{{ field.name }}_group">
      <label class="form-label">{{ label_text }}</label>
      <div class="existing-entry" id="{{ field.name }}_existing">
          {{ field(class="form-control") }}
          {% for error in field.errors %}
              <span class="text-danger">{{ error }}</span>
          {% endfor %}
          <small>
              <a href="javascript:void(0)" onclick="toggleNewEntry('{{ field.name }}')">
                  Add new {{ label_text }}
              </a>
          </small>
      </div>
      <div class="new-entry" id="{{ field.name }}_new" style="display: none;">
          {{ input_field(class="form-control", placeholder=placeholder_text) }}
          {% for error in input_field.errors %}
              <span class="text-danger">{{ error }}</span>
          {% endfor %}
          <br>
          {{ desc_field.label(class="form-label") }}
          {{ desc_field(class="form-control", placeholder=desc_placeholder) }}
          {% for error in desc_field.errors %}
              <span class="text-danger">{{ error }}</span>
          {% endfor %}
          <small>
              <a href="javascript:void(0)" onclick="toggleNewEntry('{{ field.name }}')">
                  Cancel
              </a>
          </small>
      </div>
  </div>
{% endmacro %}

{% block content %}
<div class="container">
  <h2>Create a New Position</h2>
  <form id="positionForm" method="POST" action="{{ url_for('position_data_assignment_bp.create_position_form') }}">
      {{ form_create_position.hidden_tag() }}

      {# Render Related Fields #}
      {{ render_field_with_toggle(form_create_position.area, form_create_position.area_input, "Area", "Enter new Area if not listed") }}
      {{ render_field_with_toggle(form_create_position.equipment_group, form_create_position.equipment_group_input, "Equipment Group", "Enter new Equipment Group if not listed") }}
      {{ render_field_with_toggle_and_description(form_create_position.model, form_create_position.model_input, form_create_position.model_description, "Model", "Enter new Model if not listed", "Enter Model Description") }}
      {{ render_field_with_toggle(form_create_position.asset_number, form_create_position.asset_number_input, "Asset Number", "Enter new Asset Number if not listed") }}
      {{ render_field_with_toggle(form_create_position.location, form_create_position.location_input, "Location", "Enter new Location if not listed") }}
      {{ render_field_with_toggle(form_create_position.assembly, form_create_position.assembly_input, "Assembly", "Enter new Assembly if not listed") }}
      {# Updated field: previously subassembly, now component_assembly #}
      {{ render_field_with_toggle(form_create_position.component_assembly, form_create_position.component_assembly_input, "Component Assembly", "Enter new Component Assembly if not listed") }}
      {{ render_field_with_toggle(form_create_position.assembly_view, form_create_position.assembly_view_input, "Assembly View", "Enter new Assembly View if not listed") }}

      <!-- Custom Block for Site Location (Title and Room Number) -->
      <div class="form-group" id="{{ form_create_position.site_location.name }}_group">
          <label class="form-label">Site Location</label>
          <div class="existing-entry" id="{{ form_create_position.site_location.name }}_existing">
              {{ form_create_position.site_location(class="form-control") }}
              {% for error in form_create_position.site_location.errors %}
                  <span class="text-danger">{{ error }}</span>
              {% endfor %}
              <small>
                  <a href="javascript:void(0)" onclick="toggleNewEntry('{{ form_create_position.site_location.name }}')">
                      Add new Site Location
                  </a>
              </small>
          </div>
          <div class="new-entry" id="{{ form_create_position.site_location.name }}_new" style="display: none;">
              {{ form_create_position.site_location_input(class="form-control", placeholder="Enter new Site Location title if not listed") }}
              {% for error in form_create_position.site_location_input.errors %}
                  <span class="text-danger">{{ error }}</span>
              {% endfor %}
              <br>
              {{ form_create_position.site_location_room.label(class="form-label") }}
              {{ form_create_position.site_location_room(class="form-control", placeholder="Enter Room Number") }}
              {% for error in form_create_position.site_location_room.errors %}
                  <span class="text-danger">{{ error }}</span>
              {% endfor %}
              <small>
                  <a href="javascript:void(0)" onclick="toggleNewEntry('{{ form_create_position.site_location.name }}')">
                      Cancel
                  </a>
              </small>
          </div>
      </div>

      <!-- Submit Button -->
      <div class="form-group">
          {{ form_create_position.submit(class="btn btn-primary") }}
      </div>
  </form>
</div>

<!-- Loading Spinner (for visual feedback on submission) -->
<div id="loadingSpinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- JavaScript for toggling new inputs and showing the spinner -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    /**
     * Toggle between the existing entry and new entry for a field.
     * Expects element IDs in the format <fieldName>_existing and <fieldName>_new.
     *
     * @param {string} fieldName - The base name of the field.
     */
    function toggleNewEntry(fieldName) {
        var existingDiv = document.getElementById(fieldName + "_existing");
        var newDiv = document.getElementById(fieldName + "_new");
        if (!existingDiv || !newDiv) {
            console.warn(`Elements for field ${fieldName} not found.`);
            return;
        }
        if (existingDiv.style.display === "none" || newDiv.style.display === "block") {
            // Hide new entry and show existing dropdown
            existingDiv.style.display = "block";
            newDiv.style.display = "none";
            // Clear input fields in the new entry section
            var inputs = newDiv.querySelectorAll("input, textarea");
            inputs.forEach(function(input) {
                input.value = "";
            });
        } else {
            // Hide existing dropdown and show new entry
            existingDiv.style.display = "none";
            newDiv.style.display = "block";
        }
    }

    // Expose the toggleNewEntry function globally so inline HTML can call it.
    window.toggleNewEntry = toggleNewEntry;

    // Show loading spinner on form submission.
    var form = document.getElementById("positionForm");
    if (form) {
        form.addEventListener("submit", function() {
            var spinner = document.getElementById("loadingSpinner");
            if (spinner) {
                spinner.style.display = "block";
            }
        });
    } else {
        console.warn('Form with id "positionForm" not found.');
    }
});
</script>
{% endblock %}
