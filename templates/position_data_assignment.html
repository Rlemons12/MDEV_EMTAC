{% extends "base.html" %}

{% block extra_head %}
    <!-- Include base and custom styles for this page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/position_data_assignment.css') }}">
{% endblock %}

{% block title %}Position Data Assignment{% endblock %}

{% block content %}
<div class="main-container">

    <!-- Sidebar and Menu -->
    <div class="hamburger" id="hamburger">&#9776;</div>
    <div class="sidebar" id="sidebar">
        <h2>Menu</h2>
        {% if session['user_level'] == 'ADMIN' or session['user_level'] == 'LEVEL_III' %}
            <a href="/" style="color: #FFFFFF;">Return to Main Page</a>
        {% endif %}

        {% if session['user_level'] == 'ADMIN' or session['user_level'] == 'LEVEL_III' %}
            <a href="/upload_image" style="color: #39FF14;" class="upload-button">To Search and Upload</a>
            <a href="/troubleshooting_guide" style="color: #39FF14;">To Update Troubleshooting Guide</a>
        {% endif %}
        <a href="/logout" style="color: #FF5F1F;" class="logout-button">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="content">
        <h1>Position Data Assignment</h1>

        <!-- Search Section (Collapsible) -->
        <details>
            <summary>Search Position</summary>
            <form id="searchPositionForm" method="get">
                <!-- Area Dropdown -->
                <div>
                    <label for="pda_areaDropdown">Area:</label>
                    <select name="area_id" id="pda_areaDropdown">
                        <option value="">Select Area</option>
                        {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Equipment Group Dropdown -->
                <div>
                    <label for="pda_equipmentGroupDropdown">Equipment Group:</label>
                    <select name="equipment_group_id" id="pda_equipmentGroupDropdown" disabled>
                        <option value="">Select Equipment Group</option>
                    </select>
                </div>

                <!-- Model Dropdown -->
                <div>
                    <label for="pda_modelDropdown">Model:</label>
                    <select name="model_id" id="pda_modelDropdown" disabled>
                        <option value="">Select Model</option>
                    </select>
                </div>

                <!-- Asset Number Dropdown or Input -->
                <div>
                    <label for="pda_assetNumberDropdown">Asset Number:</label>
                    <select name="asset_number_id" id="pda_assetNumberDropdown" disabled>
                        <option value="">Select Asset Number</option>
                    </select>
                    <input type="text" name="asset_number_input" id="pda_assetNumberInput" placeholder="Or type Asset Number">
                </div>

                <!-- Location Dropdown or Input -->
                <div>
                    <label for="pda_locationDropdown">Location:</label>
                    <select name="location_id" id="pda_locationDropdown" disabled>
                        <option value="">Select Location</option>
                    </select>
                    <input type="text" name="location_input" id="pda_locationInput" placeholder="Or type Location">
                </div>

                <!-- Site Location Dropdown -->
                <div>
                    <label for="pda_siteLocation">Site Location:</label>
                    <select name="site_location_id" id="pda_siteLocation" disabled>
                        <option value="">Select Site Location</option>
                    </select>
                </div>

                <!-- Search Button -->
                <button type="button" id="searchPositionBtn">Search Position</button>
            </form>
        </details>

<details id="addPositionDependencies">
    <summary>Add Position Dependencies</summary>

    <form id="addPositionDependenciesForm" action="{{ url_for('position_data_assignment_data_add_dependencies_bp.add_position') }}" method="post" enctype="multipart/form-data">
        <!-- Display the position information -->
        <div>
            <h3>Adding Position Dependencies for: {{ position.id }} - {{ position.name }}</h3>
        </div>

        <!-- Hidden field for Position ID -->
        <input type="hidden" id="position_id" name="position_id" value="{{ position.id }}">

        <!-- Add Area Section -->
        <details>
            <summary>Select or Add Area</summary>
            <div id="areaContainer">
                <div id="areaFieldsWrapper">
                    <!-- Loop for adding multiple areas -->
                    <div class="areaFields">
                        <label for="new_areaDropdown">Select Area:</label>
                        <select name="area_id[]" id="new_areaDropdown">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                                <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                            <option value="new">New Area...</option>
                        </select>

                        <div id="newAreaFields" style="display:none;">
                            <h4>New Area</h4>
                            <label for="new_area_name">New Area Name:</label>
                            <input type="text" id="new_area_name" name="new_area_name[]">
                            <label for="new_area_description">New Area Description:</label>
                            <textarea id="new_area_description" name="new_area_description[]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Button to add another Area -->
                <button type="button" id="addAnotherAreaBtn">Add Another Area</button>
            </div>
        </details>

        <!-- Add Equipment Group Section -->
        <details>
            <summary>Select or Add Equipment Group</summary>
            <div id="equipmentGroupContainer">
                <div id="equipmentGroupFieldsWrapper">
                    <!-- Loop for adding multiple equipment groups -->
                    <div class="equipmentGroupFields">
                        <label for="new_equipmentGroupDropdown">Select Equipment Group:</label>
                        <select name="equipment_group_id[]" id="new_equipmentGroupDropdown" disabled>
                            <option value="">Select Equipment Group</option>
                            <option value="new">New Equipment Group...</option>
                        </select>

                        <div id="newEquipmentGroupFields" style="display:none;">
                            <h4>New Equipment Group</h4>
                            <label for="new_equipmentGroup_name">New Equipment Group Name:</label>
                            <input type="text" id="new_equipmentGroup_name" name="new_equipmentGroup_name[]">
                            <label for="new_equipmentGroup_description">New Equipment Group Description:</label>
                            <textarea id="new_equipmentGroup_description" name="new_equipmentGroup_description[]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Button to add another Equipment Group -->
                <button type="button" id="addAnotherEquipmentGroupBtn">Add Another Equipment Group</button>
            </div>
        </details>

        <!-- Add Model Section -->
        <details>
            <summary>Select or Add Model</summary>
            <div id="modelContainer">
                <div id="modelFieldsWrapper">
                    <!-- Loop for adding multiple models -->
                    <div class="modelFields">
                        <label for="new_modelDropdown">Select Model:</label>
                        <select name="model_id[]" id="new_modelDropdown" disabled>
                            <option value="">Select Model</option>
                            <option value="new">New Model...</option>
                        </select>

                        <div id="newModelFields" style="display:none;">
                            <h4>New Model</h4>
                            <label for="new_model_name">New Model Name:</label>
                            <input type="text" id="new_model_name" name="new_model_name[]">
                            <label for="new_model_description">New Model Description:</label>
                            <textarea id="new_model_description" name="new_model_description[]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Button to add another Model -->
                <button type="button" id="addAnotherModelBtn">Add Another Model</button>
            </div>
        </details>

        <!-- Add Asset Numbers Section (allow multiple asset numbers) -->
        <details>
            <summary>Select or Add Asset Numbers</summary>
            <div id="assetNumberContainer">
                <div id="assetNumberFieldsWrapper">
                    <!-- Loop for adding multiple asset numbers -->
                    <div class="assetNumberFields">
                        <label for="new_assetNumberDropdown">Select Asset Number:</label>
                        <select name="asset_number_id[]" id="new_assetNumberDropdown" disabled>
                            <option value="">Select Asset Number</option>
                            <option value="new">New Asset Number...</option>
                        </select>

                        <div id="newAssetNumberFields" style="display:none;">
                            <h4>New Asset Number</h4>
                            <label for="new_assetNumber">New Asset Number:</label>
                            <input type="text" id="new_assetNumber" name="new_assetNumber[]">
                            <label for="new_assetNumber_description">New Asset Number Description:</label>
                            <textarea id="new_assetNumber_description" name="new_assetNumber_description[]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Button to add another Asset Number -->
                <button type="button" id="addAnotherAssetNumberBtn">Add Another Asset Number</button>
            </div>
        </details>

        <!-- Add Locations Section (allow multiple locations) -->
        <details>
            <summary>Select or Add Locations</summary>
            <div id="locationContainer">
                <div id="locationFieldsWrapper">
                    <!-- Loop for adding multiple locations -->
                    <div class="locationFields">
                        <label for="new_locationDropdown">Select Location:</label>
                        <select name="location_id[]" id="new_locationDropdown" disabled>
                            <option value="">Select Location</option>
                            <option value="new">New Location...</option>
                        </select>

                        <div id="newLocationFields" style="display:none;">
                            <h4>New Location</h4>
                            <label for="new_location_name">New Location Name:</label>
                            <input type="text" id="new_location_name" name="new_location_name[]">
                            <label for="new_location_description">New Location Description:</label>
                            <textarea id="new_location_description" name="new_location_description[]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Button to add another Location -->
                <button type="button" id="addAnotherLocationBtn">Add Another Location</button>
            </div>
        </details>

        <!-- Add Site Locations Section (allow multiple site locations) -->
        <details>
            <summary>Select or Add Site Locations</summary>
            <div id="siteLocationContainer">
                <div id="siteLocationFieldsWrapper">
                    <!-- Loop for adding multiple site locations -->
                    <div class="siteLocationFields">
                        <label for="new_siteLocationDropdown">Select Site Location:</label>
                        <!-- Searchable dropdown using Select2 -->
                        <select name="site_location_id[]" id="new_siteLocationDropdown" class="site-location-search">
                            <option value="">Select Site Location</option>
                            <option value="new">New Site Location...</option>
                        </select>

                        <!-- Fields for new site location input -->
                        <div id="newSiteLocationFields" style="display:none;">
                            <h4>New Site Location</h4>
                            <label for="new_siteLocation_title">New Site Location Title:</label>
                            <input type="text" id="new_siteLocation_title" name="new_siteLocation_title[]">
                            <label for="new_siteLocation_roomNumber">Room Number:</label>
                            <input type="text" id="new_siteLocation_roomNumber" name="new_siteLocation_room_number[]">
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <!-- Submit Button -->
        <button type="submit">Add Position Dependencies</button>
    </form>
</details>

        <!-- Update Section (Collapsible) -->
        <details id="updateSection" >
            <summary>Update Position Data</summary>

            <form id="updatePositionForm" action="{{ url_for('position_data_assignment_bp.update_position') }}" method="post" enctype="multipart/form-data">
                <!-- Display the position information (ID and Name, for example) -->
                <div>
                    <h3>Editing Position: {{ position.id }} - {{ position.name }}</h3>
                </div>

                <!-- Hidden field for Position ID (make it visible for debugging) -->
                <input type="text" id="position_id" name="position_id" value="{{ position.id }}">

                <!-- Visible field for Position ID (for display purposes) -->
                <div>
                    <label for="position_display">Position ID:</label>
                    <input type="text" id="position_display" name="position_display" value="{{ position.id }}" readonly>
                </div>

                <!-- Update Area (Collapsible Section) -->
                <details>
                    <summary>Update Area</summary>
                    <div>
                        <label for="edit_areaDropdown">Edit Area:</label>
                        <select name="area_id" id="edit_areaDropdown">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                                <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>

                        <!-- Name and Description for Area -->
                        <label for="edit_area_name">Area Name:</label>
                        <input type="text" id="edit_area_name" name="area_name" value="{{ position.area.name if position.area else '' }}">

                        <label for="edit_area_description">Area Description:</label>
                        <textarea id="edit_area_description" name="area_description">{{ position.area.description if position.area else '' }}</textarea>
                    </div>
                </details>

        <!-- Update Section (Collapsible) -->
    <details id="updateSection" open>
    <summary>Update Position Data</summary>

    <form id="updatePositionForm" action="{{ url_for('position_data_assignment_bp.update_position') }}" method="post" enctype="multipart/form-data">
        <!-- Display the position information (ID and Name, for example) -->
        <div>
            <h3>Editing Position: {{ position.id }} - {{ position.name }}</h3>
        </div>

        <!-- Hidden field for Position ID (make it visible for debugging) -->
        <input type="text" id="position_id" name="position_id" value="{{ position.id }}">

        <!-- Visible field for Position ID (for display purposes) -->
        <div>
            <label for="position_display">Position ID:</label>
            <input type="text" id="position_display" name="position_display" value="{{ position.id }}" readonly>
        </div>

        <!-- Update Area (Collapsible Section) -->
        <details>
            <summary>Update Area</summary>
            <div>
                <label for="edit_areaDropdown">Edit Area:</label>
                <select name="area_id" id="edit_areaDropdown">
                    <option value="">Select Area</option>
                    {% for area in areas %}
                        <option value="{{ area.id }}" {% if position and area.id == position.area_id %}selected{% endif %}>{{ area.name }}</option>
                    {% endfor %}
                </select>

                <!-- Name and Description for Area -->
                <label for="edit_area_name">Area Name:</label>
                <input type="text" id="edit_area_name" name="area_name" value="{{ position.area.name if position.area else '' }}">

                <label for="edit_area_description">Area Description:</label>
                <textarea id="edit_area_description" name="area_description">{{ position.area.description if position.area else '' }}</textarea>
            </div>
        </details>

        <!-- Update Equipment Group (Collapsible Section) -->
        <details>
            <summary>Update Equipment Group</summary>
            <div>
                <label for="edit_equipmentGroupDropdown">Edit Equipment Group:</label>
                <select name="equipment_group_id" id="edit_equipmentGroupDropdown">
                    <option value="">Select Equipment Group</option>
                    {% for group in equipment_groups %}
                        <option value="{{ group.id }}" {% if position and group.id == position.equipment_group_id %}selected{% endif %}>{{ group.name }}</option>
                    {% endfor %}
                </select>

                <!-- Name for Equipment Group -->
                <label for="edit_equipmentGroup_name">Equipment Group Name:</label>
                <input type="text" id="edit_equipmentGroup_name" name="equipment_group_name" value="{{ position.equipment_group.name if position.equipment_group else '' }}">

                <!-- Description for Equipment Group -->
                <label for="edit_equipmentGroup_description">Equipment Group Description:</label>
                <textarea id="edit_equipmentGroup_description" name="equipment_group_description">{{ position.equipment_group.description if position.equipment_group else '' }}</textarea>
            </div>
        </details>

        <!-- Update Model (Collapsible Section) -->
        <details>
            <summary>Update Model</summary>
            <div>
                <label for="edit_modelDropdown">Edit Model:</label>
                <select name="model_id" id="edit_modelDropdown">
                    <option value="">Select Model</option>
                    {% for model in models %}
                        <option value="{{ model.id }}" {% if position and model.id == position.model_id %}selected{% endif %}>{{ model.name }}</option>
                    {% endfor %}
                </select>

                <!-- Name and Description for Model -->
                <label for="edit_model_name">Model Name:</label>
                <input type="text" id="edit_model_name" name="model_name" value="{{ position.model.name if position.model else '' }}">

                <label for="edit_model_description">Model Description:</label>
                <textarea id="edit_model_description" name="model_description">{{ position.model.description if position.model else '' }}</textarea>
            </div>
        </details>

        <!-- Update Asset Number (Collapsible Section) -->
        <details>
            <summary>Update Asset Number</summary>
            <div>
                <label for="edit_assetNumberDropdown">Edit Asset Number:</label>
                <select name="asset_number_id" id="edit_assetNumberDropdown">
                    <option value="">Select Asset Number</option>
                    {% for asset in asset_numbers %}
                        <option value="{{ asset.id }}" {% if position and asset.id == position.asset_number_id %}selected{% endif %}>{{ asset.number }}</option>
                    {% endfor %}
                </select>

                <!-- Number and Description for Asset Number -->
                <label for="edit_assetNumber">Asset Number:</label>
                <input type="text" id="edit_assetNumber" name="asset_number" value="{{ position.asset_number.number if position.asset_number else '' }}">

                <label for="edit_assetNumber_description">Asset Number Description:</label>
                <textarea id="edit_assetNumber_description" name="asset_number_description">{{ position.asset_number.description if position.asset_number else '' }}</textarea>
            </div>
        </details>

        <!-- Update Location (Collapsible Section) -->
        <details>
            <summary>Update Location</summary>
            <div>
                <label for="edit_locationDropdown">Edit Location:</label>
                <select name="location_id" id="edit_locationDropdown">
                    <option value="">Select Location</option>
                    {% for location in locations %}
                        <option value="{{ location.id }}" {% if position and location.id == position.location_id %}selected{% endif %}>{{ location.name }}</option>
                    {% endfor %}
                </select>

                <!-- Name for Location -->
                <label for="edit_location_name">Location Name:</label>
                <input type="text" id="edit_location_name" name="location_name" value="{{ position.location.name if position.location else '' }}">

                <!-- Description for Location -->
                <label for="edit_location_description">Location Description:</label>
                <textarea id="edit_location_description" name="location_description">{{ position.location.description if position.location else '' }}</textarea>
            </div>

        </details>
        <!-- Update Site Location (Collapsible Section) -->
        <details>
            <summary>Update Site Location</summary>
            <div>
                <label for="edit_siteLocationDropdown">Edit Site Location:</label>
                <select name="site_location_id" id="edit_siteLocationDropdown">
                    <option value="">Select Site Location</option>
                    {% for site in site_locations %}
                        <option value="{{ site.id }}" {% if position and site.id == position.site_location_id %}selected{% endif %}>{{ site.title }}</option>
                    {% endfor %}
                </select>

                <!-- Title and Room Number for Site Location -->
                <label for="edit_siteLocation_title">Site Location Title:</label>
                <input type="text" id="edit_siteLocation_title" name="site_location_title" value="{{ position.site_location.title if position.site_location else '' }}">

                <label for="edit_siteLocation_roomNumber">Room Number:</label>
                <input type="text" id="edit_siteLocation_roomNumber" name="site_location_room_number" value="{{ position.site_location.room_number if position.site_location else '' }}">
            </div>
        </details>

        <!-- Submit Button -->
        <button type="submit">Update Position</button>
    </form>

    <p>No position selected for update. Please search for a position first.</p>
</details>

<!-- Document Section -->
<details>
    <summary>Manage Documents</summary>

    <!-- Search Bar for Filtering Documents -->
    <div>
        <label for="search-documents">Search Documents:</label>
        <input type="text" id="search-documents" placeholder="Search documents..." oninput="filterDocuments()">
    </div>

    <!-- Dynamically populated section for displaying existing documents -->
    <h4>Existing Documents:</h4>
    <div id="existing-documents-list" class="scrollable-list"></div>

    <!-- Pagination Controls -->
    <div id="documents-pagination" class="pagination-controls"></div>
</details>

        <!-- Parts Input -->
<details>
    <summary>Manage Parts</summary>
    <div>
        <label for="search-parts">Search Parts:</label>
        <input type="text" id="search-parts" placeholder="Search parts...">
    </div>
    <div id="parts-container">
        <h4>Existing Parts:</h4>
        <div id="existing-parts-list" class="scrollable-list"></div>
    </div>
    <div id="parts-pagination" class="pagination-controls"></div>
    <h4>Add New Parts:</h4>
    <div class="part-entry">
        <label>Part Number:</label>
        <input type="text" name="part_numbers[]">
    </div>
    <button type="button" onclick="addPartEntry()">Add Another Part</button>
</details>

<!-- Images Section -->
<details>
    <summary>Manage Images</summary>
    <div>
        <label for="search-images">Search Images:</label>
        <input type="text" id="search-images" placeholder="Search images...">
    </div>
    <div id="images-container">
        <h4>Existing Images:</h4>
        <div id="existing-images-list" class="scrollable-list"></div>
    </div>
    <div id="images-pagination" class="pagination-controls"></div>
    <h4>Upload New Images:</h4>
    <div>
        <label for="images">Upload Images:</label>
        <input type="file" name="images[]" multiple accept="image/*">
    </div>
</details>

<!-- Drawings Section -->
<details>
    <summary>Manage Drawings</summary>
    <div>
        <label for="search-drawings">Search Drawings:</label>
        <input type="text" id="search-drawings" placeholder="Search drawings...">
    </div>
    <div id="drawings-container">
        <h4>Existing Drawings:</h4>
        <div id="existing-drawings-list" class="scrollable-list"></div>
    </div>
    <div id="drawings-pagination" class="pagination-controls"></div>
    <h4>Upload New Drawings:</h4>
    <div>
        <label for="drawings">Upload Drawings:</label>
        <input type="file" name="drawings[]" multiple accept=".pdf,.jpg,.jpeg,.png">
    </div>
</details>

{% endblock %}

{% block extra_scripts %}
<!-- Include Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Include jQuery from a CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{{ url_for('static', filename='js/position_data_assignment_data_add_dependencies.js') }}"></script>
<script src="{{ url_for('static', filename='js/get_position_data_assignment_data.js') }}"></script>
<script src="{{ url_for('static', filename='js/base_sidebar.js') }}"></script>

<script>
    var getEquipmentGroupsUrl = "{{ url_for('position_data_assignment_bp.get_equipment_groups') }}";
    var getModelsUrl = "{{ url_for('position_data_assignment_bp.get_models') }}";
    var getAssetNumbersUrl = "{{ url_for('position_data_assignment_bp.get_asset_numbers') }}";
    var getLocationsUrl = "{{ url_for('position_data_assignment_bp.get_locations') }}";
    var getSiteLocationsUrl = "{{ url_for('position_data_assignment_bp.get_site_locations') }}";
    var getPositionsUrl = "{{ url_for('position_data_assignment_bp.get_positions') }}";

    $('#searchPositionBtn').click(function() {
    $.ajax({
        url: getPositionsUrl,
        method: 'GET',
        data: $('#searchPositionForm').serialize(),
        success: function(data) {
            console.log('Positions data:', data); // Check the data structure
            // Here, render or debug the data to ensure it's being received correctly.
        },
        error: function(xhr, status, error) {
            console.error("Error fetching positions:", error);
            alert("An error occurred while fetching positions.");
        }
    });
});


    function addPartEntry() {
        const container = document.getElementById('parts-container');
        const div = document.createElement('div');
        div.classList.add('part-entry');
        div.innerHTML = `
            <label>Part Number:</label>
            <input type="text" name="part_numbers[]">
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}
