{% extends "base.html" %}

{% block extra_head %}
    <!-- Include base and custom styles for this page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/position_data_assignment.css') }}">
{% endblock %}

{% block title %}Position Data Assignment{% endblock %}

{% block content %}
<div class="main-container">

    <!-- Sidebar and Menu -->
    <div class="hamburger" id="hamburger">&#9776;</div>
    <div class="sidebar" id="sidebar">
        <h2>Menu</h2>
        {% if session['user_level'] == 'ADMIN' or session['user_level'] == 'LEVEL_III' %}
            <a href="/" style="color:  #FFFFFF;">Return to Main Page</a>
        {%  endif %}

        {% if session['user_level'] == 'ADMIN' or session['user_level'] == 'LEVEL_III' %}
            <a href="/upload_image" style="color: #39FF14;" class="upload-button">To Search and Upload</a>
            <a href="/troubleshooting_guide" style="color: #39FF14;">To Update Troubleshooting Guide</a>
        {% endif %}
        <a href="/logout" style="color:  #FF5F1F;" class="logout-button">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="content">
        <h1>Position Data Assignment</h1>

        <!-- Search Section (Collapsible) -->
        <details>
            <summary>Search Position</summary>
            <form id="searchPositionForm" method="get">
                <!-- Area Dropdown -->
                <div>
                    <label for="pda_areaDropdown">Area:</label>
                    <select name="area_id" id="pda_areaDropdown">
                        <option value="">Select Area</option>
                        {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Equipment Group Dropdown -->
                <div>
                    <label for="pda_equipmentGroupDropdown">Equipment Group:</label>
                    <select name="equipment_group_id" id="pda_equipmentGroupDropdown" disabled>
                        <option value="">Select Equipment Group</option>
                    </select>
                </div>

                <!-- Model Dropdown -->
                <div>
                    <label for="pda_modelDropdown">Model:</label>
                    <select name="model_id" id="pda_modelDropdown" disabled>
                        <option value="">Select Model</option>
                    </select>
                </div>

                <!-- Asset Number Dropdown or Input -->
                <div>
                    <label for="pda_assetNumberDropdown">Asset Number:</label>
                    <select name="asset_number_id" id="pda_assetNumberDropdown" disabled>
                        <option value="">Select Asset Number</option>
                    </select>
                    <input type="text" name="asset_number_input" id="pda_assetNumberInput" placeholder="Or type Asset Number">
                </div>

                <!-- Location Dropdown or Input -->
                <div>
                    <label for="pda_locationDropdown">Location:</label>
                    <select name="location_id" id="pda_locationDropdown" disabled>
                        <option value="">Select Location</option>
                    </select>
                    <input type="text" name="location_input" id="pda_locationInput" placeholder="Or type Location">
                </div>

                <!-- Site Location Dropdown -->
                <div>
                    <label for="pda_siteLocation">Site Location:</label>
                    <select name="site_location_id" id="pda_siteLocation" disabled>
                        <option value="">Select Site Location</option>
                    </select>
                </div>

                <!-- Search Button -->
                <button type="button" id="searchPositionBtn">Search Position</button>
            </form>
        </details>

         <!-- Update Section (Collapsible) -->
<details id="updateSection">
    <summary>Update Position Data</summary>

    {% if position %}
    <form id="updatePositionForm" action="{{ url_for('position_data_assignment_bp.update_position') }}" method="post" enctype="multipart/form-data">
        <!-- Hidden field for Position ID -->
        <input type="hidden" id="position_id" name="position_id" value="{{ position.id }}">

        <!-- Update Area -->
        <div>
            <label for="edit_areaDropdown">Edit Area:</label>
            <select name="area_id" id="edit_areaDropdown">
                <option value="">Select Area</option>
                {% for area in areas %}
                    <option value="{{ area.id }}" {% if position and area.id == position.area_id %}selected{% endif %}>{{ area.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Update Equipment Group -->
        <div>
            <label for="edit_equipmentGroupDropdown">Edit Equipment Group:</label>
            <select name="equipment_group_id" id="edit_equipmentGroupDropdown">
                <option value="">Select Equipment Group</option>
                {% for group in equipment_groups %}
                    <option value="{{ group.id }}" {% if position and group.id == position.equipment_group_id %}selected{% endif %}>{{ group.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Update Model -->
        <div>
            <label for="edit_modelDropdown">Edit Model:</label>
            <select name="model_id" id="edit_modelDropdown">
                <option value="">Select Model</option>
                {% for model in models %}
                    <option value="{{ model.id }}" {% if position and model.id == position.model_id %}selected{% endif %}>{{ model.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Update Asset Number -->
        <div>
            <label for="edit_assetNumberDropdown">Edit Asset Number:</label>
            <select name="asset_number_id" id="edit_assetNumberDropdown">
                <option value="">Select Asset Number</option>
                {% for asset in asset_numbers %}
                    <option value="{{ asset.id }}" {% if position and asset.id == position.asset_number_id %}selected{% endif %}>{{ asset.number }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Update Location -->
        <div>
            <label for="edit_locationDropdown">Edit Location:</label>
            <select name="location_id" id="edit_locationDropdown">
                <option value="">Select Location</option>
                {% for location in locations %}
                    <option value="{{ location.id }}" {% if position and location.id == position.location_id %}selected{% endif %}>{{ location.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Update Site Location -->
        <div>
            <label for="edit_siteLocationDropdown">Edit Site Location:</label>
            <select name="site_location_id" id="edit_siteLocationDropdown">
                <option value="">Select Site Location</option>
                {% for site in site_locations %}
                    <option value="{{ site.id }}" {% if position and site.id == position.site_location_id %}selected{% endif %}>{{ site.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Submit Button -->
        <button type="submit">Update Position</button>
    </form>
    {% else %}
        <p>No position selected for update. Please search for a position first.</p>
    {% endif %}
</details>

<!-- Document Section -->
<details>
    <summary>Manage Documents</summary>

    <!-- Search Bar for Filtering Documents -->
    <div>
        <label for="search-documents">Search Documents:</label>
        <input type="text" id="search-documents" placeholder="Search documents..." oninput="filterDocuments()">
    </div>

    <!-- Dynamically populated section for displaying existing documents -->
    <h4>Existing Documents:</h4>
    <div id="existing-documents-list" class="scrollable-list"></div>

    <!-- Pagination Controls -->
    <div id="documents-pagination" class="pagination-controls"></div>
</details>

        <!-- Parts Input -->
<details>
    <summary>Manage Parts</summary>
    <div>
        <label for="search-parts">Search Parts:</label>
        <input type="text" id="search-parts" placeholder="Search parts...">
    </div>
    <div id="parts-container">
        <h4>Existing Parts:</h4>
        <div id="existing-parts-list" class="scrollable-list"></div>
    </div>
    <div id="parts-pagination" class="pagination-controls"></div>
    <h4>Add New Parts:</h4>
    <div class="part-entry">
        <label>Part Number:</label>
        <input type="text" name="part_numbers[]">
    </div>
    <button type="button" onclick="addPartEntry()">Add Another Part</button>
</details>

<!-- Images Section -->
<details>
    <summary>Manage Images</summary>
    <div>
        <label for="search-images">Search Images:</label>
        <input type="text" id="search-images" placeholder="Search images...">
    </div>
    <div id="images-container">
        <h4>Existing Images:</h4>
        <div id="existing-images-list" class="scrollable-list"></div>
    </div>
    <div id="images-pagination" class="pagination-controls"></div>
    <h4>Upload New Images:</h4>
    <div>
        <label for="images">Upload Images:</label>
        <input type="file" name="images[]" multiple accept="image/*">
    </div>
</details>

<!-- Drawings Section -->
<details>
    <summary>Manage Drawings</summary>
    <div>
        <label for="search-drawings">Search Drawings:</label>
        <input type="text" id="search-drawings" placeholder="Search drawings...">
    </div>
    <div id="drawings-container">
        <h4>Existing Drawings:</h4>
        <div id="existing-drawings-list" class="scrollable-list"></div>
    </div>
    <div id="drawings-pagination" class="pagination-controls"></div>
    <h4>Upload New Drawings:</h4>
    <div>
        <label for="drawings">Upload Drawings:</label>
        <input type="file" name="drawings[]" multiple accept=".pdf,.jpg,.jpeg,.png">
    </div>
</details>

{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='js/get_position_data_assignment_data.js') }}"></script>
<script src="{{ url_for('static', filename='js/base_sidebar.js') }}"></script>
<script>
    var getEquipmentGroupsUrl = "{{ url_for('position_data_assignment_bp.get_equipment_groups') }}";
    var getModelsUrl = "{{ url_for('position_data_assignment_bp.get_models') }}";
    var getAssetNumbersUrl = "{{ url_for('position_data_assignment_bp.get_asset_numbers') }}";
    var getLocationsUrl = "{{ url_for('position_data_assignment_bp.get_locations') }}";
    var getSiteLocationsUrl = "{{ url_for('position_data_assignment_bp.get_site_locations') }}";
    var getPositionsUrl = "{{ url_for('position_data_assignment_bp.get_positions') }}";

    $('#searchPositionBtn').click(function() {
    $.ajax({
        url: getPositionsUrl,
        method: 'GET',
        data: $('#searchPositionForm').serialize(),
        success: function(data) {
            console.log('Positions data:', data); // Check the data structure
            // Here, render or debug the data to ensure it's being received correctly.
        },
        error: function(xhr, status, error) {
            console.error("Error fetching positions:", error);
            alert("An error occurred while fetching positions.");
        }
    });
});


    function addPartEntry() {
        const container = document.getElementById('parts-container');
        const div = document.createElement('div');
        div.classList.add('part-entry');
        div.innerHTML = `
            <label>Part Number:</label>
            <input type="text" name="part_numbers[]">
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}
