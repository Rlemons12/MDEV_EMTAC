{% extends "module_template_html/base_template.html" %}

{% block title %}Home | EMTAC Assistant{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index_styles.css') }}">
{% endblock %}

{% block content %}
    <div class="answer-section" id="answer-section">
        <p id="answer"></p>
    </div>

    <div class="thumbnails-section" id="thumbnails-section">
        <!-- Thumbnails will be displayed here -->
    </div>

    <div class="doc-links-section" id="doc-links-section">
        <!-- Hoverable links for relevant documents will be displayed here -->
    </div>

    <div class="user-input-container">
        <input type="text" id="user_id" placeholder="User ID" value="{{ employee_id }}" readonly style="display: none;">
        <select id="area" style="display: none;">
            <!-- Options will be populated here -->
        </select>
        <div class="input-and-button">
            <textarea id="user_input" placeholder="Your Question" rows="2" cols="50"></textarea>
            <button id="submit-question" onclick="submitQuestion()">Ask</button>
        </div>
    </div>

    <div class="comment-box">
        <textarea id="user_comment" placeholder="Comment, suggestions or corrections"></textarea>
        <div class="rating-section">
            <label for="rating">Rating:</label>
            <select id="rating">
                {% for i in range(1, 11) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
            <button id="submit_comment_rating">Submit</button>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='chatbot.js') }}"></script>
<script src="{{ url_for('static', filename='chatbot_display_thumbnails.js') }}"></script>
<script src="{{ url_for('static', filename='update_qanda_table.js') }}"></script>
<script>
    document.getElementById("sidebarCollapse").onclick = function () {
        document.querySelector(".main-container").classList.toggle("collapsed");
    };

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll(".toggle-button");
        toggleButtons.forEach(button => {
            button.onclick = function () {
                this.classList.toggle("active");
            };
        });

        document.getElementById("submit-question")?.addEventListener("click", function () {
            if (typeof submitQuestion === "function") {
                submitQuestion();
            } else {
                console.error("submitQuestion function not found");
            }
        });
    });

    // Fallback in case submitQuestion doesn't exist
    if (typeof submitQuestion !== 'function') {
        function submitQuestion() {
            const userInput = document.getElementById('user_input').value;
            const userId = document.getElementById('user_id').value;

            if (!userInput.trim()) {
                alert('Please enter a question');
                return;
            }

            const answerElement = document.getElementById('answer');
            if (answerElement) {
                answerElement.innerHTML = 'Processing your question...';
            }

            fetch('/ask_question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_input: userInput, user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (answerElement) {
                    answerElement.innerHTML = data.answer || 'No answer found';
                }

                const thumbnailsSection = document.getElementById('thumbnails-section');
                if (thumbnailsSection && data.thumbnails) {
                    thumbnailsSection.innerHTML = '';
                    data.thumbnails.forEach(thumb => {
                        const img = document.createElement('img');
                        img.src = thumb.url;
                        img.alt = thumb.alt || 'Thumbnail';
                        img.className = 'thumbnail';
                        thumbnailsSection.appendChild(img);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (answerElement) {
                    answerElement.innerHTML = 'Error processing your question. Please try again.';
                }
            });
        }
    }
</script>
{% endblock %}
</html>