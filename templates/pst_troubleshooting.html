<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PST Troubleshooting Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        /* Optional: Add custom styles here */
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>PST Troubleshooting Form</h2>
        <form method="POST"
              action="{% if problem %}{{ url_for('pst_troubleshooting_bp.pst_troubleshooting_page', problem_id=problem.id) }}{% else %}{{ url_for('pst_troubleshooting_bp.pst_troubleshooting_page') }}{% endif %}"
              enctype="multipart/form-data">
            <!-- Form Fields -->
        </form>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <!-- Problem Tab (Set as Active) -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="problem-tab" data-bs-toggle="tab" data-bs-target="#problem" type="button" role="tab">Problem</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="solution-tab" data-bs-toggle="tab" data-bs-target="#solution" type="button" role="tab">Solutions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="task-tab" data-bs-toggle="tab" data-bs-target="#task" type="button" role="tab">Tasks</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="edit-task-tab" data-bs-toggle="tab" data-bs-target="#edit-task" type="button" role="tab">Edit Task</button>
                </li>
            </ul>

            <!-- Tab Contents -->
            <div class="tab-content mt-3" id="myTabContent">

                <!-- Problem Tab (Now Contains Accordion for Problem Management) -->
                <div class="tab-pane fade show active" id="problem" role="tabpanel">
                    <!-- Search Problem by Position Section -->
                    <div class="accordion" id="problemAccordion">

                        <!-- Search Problem by Position Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSearchProblem">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSearchProblem" aria-expanded="false" aria-controls="collapseSearchProblem">
                                    Search Problem by Position
                                </button>
                            </h2>
                            <div id="collapseSearchProblem" class="accordion-collapse collapse" aria-labelledby="headingSearchProblem" data-bs-parent="#problemAccordion">
                                <div class="accordion-body">
                                    <form id="searchProblemByPositionForm" method="get">
                                        <div class="mb-3">
                                            <label for="pst_areaDropdown" class="form-label">Area:</label>
                                            <select name="area_id" id="pst_areaDropdown" class="form-select">
                                                <option value="">Select Area</option>
                                                {% for area in areas %}
                                                    <option value="{{ area.id }}">{{ area.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pst_equipmentGroupDropdown" class="form-label">Equipment Group:</label>
                                            <select name="equipment_group_id" id="pst_equipmentGroupDropdown" class="form-select" disabled>
                                                <option value="">Select Equipment Group</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pst_modelDropdown" class="form-label">Model:</label>
                                            <select name="model_id" id="pst_modelDropdown" class="form-select" disabled>
                                                <option value="">Select Model</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="pst_assetNumberInput" class="form-label">Asset Number:</label>
                                            <input type="text" class="form-control" id="pst_assetNumberInput" name="asset_number" placeholder="Enter Asset Number">
                                        </div>
                                        <div class="mb-3">
                                            <label for="pst_locationInput" class="form-label">Location:</label>
                                            <input type="text" class="form-control" id="pst_locationInput" name="location" placeholder="Enter Location">
                                        </div>
                                        <div class="mb-3">
                                            <label for="pst_siteLocationDropdown" class="form-label">Site Location:</label>
                                            <select name="site_location_id" id="pst_siteLocationDropdown" class="form-select" disabled>
                                                <option value="">Select Site Location</option>
                                            </select>
                                        </div>
                                        <button type="button" id="searchProblemByPositionBtn" class="btn btn-primary mt-3">Search Problems</button>
                                    </form>
                                    <!-- Search Results -->
                                    <div id="pst_searchResults" class="mt-4" style="display: none;">
                                        <h5>Associated Problems:</h5>
                                        <ul class="list-group" id="pst_positionResultsList">
                                            <!-- Dynamic search results will appear here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Problem Form -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingNewProblem">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNewProblem"
                                        aria-expanded="false" aria-controls="collapseNewProblem">
                                    New Problem Form
                                </button>
                            </h2>
                            <div id="collapseNewProblem" class="accordion-collapse collapse" aria-labelledby="headingNewProblem" data-bs-parent="#problemAccordion">
                                <div class="accordion-body">
                                    <form id="newProblemForm" method="post">
                                        <div class="mb-3">
                                            <label for="new_problem_name" class="form-label">Problem Name</label>
                                            <input type="text" class="form-control" id="new_problem_name" name="problem_name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_problem_description" class="form-label">Problem Description</label>
                                            <textarea class="form-control" id="new_problem_description" name="problem_description" rows="3" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_areaDropdown" class="form-label">Area:</label>
                                            <select name="area_id" id="new_pst_areaDropdown" class="form-select" required>
                                                <option value="">Select Area</option>
                                                {% for area in areas %}
                                                    <option value="{{ area.id }}">{{ area.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_equipmentGroupDropdown" class="form-label">Equipment Group:</label>
                                            <select name="equipment_group_id" id="new_pst_equipmentGroupDropdown" class="form-select" required>
                                                <option value="">Select Equipment Group</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_modelDropdown" class="form-label">Model:</label>
                                            <select name="model_id" id="new_pst_modelDropdown" class="form-select" required>
                                                <option value="">Select Model</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_assetNumberInput" class="form-label">Asset Number:</label>
                                            <input type="text" class="form-control" id="new_pst_assetNumberInput" name="asset_number" placeholder="Enter Asset Number" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_locationInput" class="form-label">Location:</label>
                                            <input type="text" class="form-control" id="new_pst_locationInput" name="location" placeholder="Enter Location" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="new_pst_siteLocationDropdown" class="form-label">Site Location:</label>
                                            <select name="site_location_id" id="new_pst_siteLocationDropdown" class="form-select" required>
                                                <option value="">Select Site Location</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-success mt-3">Create Problem</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Solutions Tab -->
                <div class="tab-pane fade" id="solution" role="tabpanel">
                    <h4>Problem: {{ problem.name }}</h4>
                    <div class="mb-3">
                        <label for="existing_solutions" class="form-label">Related Solutions</label>
                        <select class="form-select" id="existing_solutions" size="5" multiple onchange="storeSolution()">
                            {% for solution in problem.solutions %}
                                <option value="{{ solution.id }}">{{ solution.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="new_solution_name" class="form-label">New Solution Name</label>
                        <input type="text" class="form-control" id="new_solution_name" name="new_solution_name">
                    </div>
                </div>

                <!-- Tasks Tab -->
                <div class="tab-pane fade" id="task" role="tabpanel">
                    <h4 id="selected-solution-name">Selected Solution: </h4>
                    <div class="mb-3">
                        <label for="existing_tasks" class="form-label">Existing Tasks</label>
                        <select class="form-select" id="existing_tasks" size="5" multiple>
                            <!-- Existing tasks will be populated based on the selected solution -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="new_task_description" class="form-label">New Task Description</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new_task_description" name="new_task_description" placeholder="Enter Task Description">
                            <button class="btn btn-outline-secondary" type="button" onclick="addNewTask()">Add Task</button>
                        </div>
                    </div>

                    <div id="new-tasks-container" class="mt-3"></div>
                </div>

                <!-- Edit Task Tab -->
                <div class="tab-pane fade" id="edit-task" role="tabpanel">
                    <div class="mb-3">
                        <label for="edit_task_name" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="edit_task_name" name="edit_task_name">
                    </div>
                    <div class="mb-3">
                        <label for="edit_task_description" class="form-label">Task Description</label>
                        <textarea class="form-control" id="edit_task_description" name="edit_task_description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="task_documents" class="form-label">Documents</label>
                        <input type="file" class="form-control" id="task_documents" name="task_documents" multiple>
                    </div>

                    <div class="mb-3">
                        <label for="task_images" class="form-label">Images</label>
                        <input type="file" class="form-control" id="task_images" name="task_images" multiple accept="image/*">
                    </div>

                    <div class="mb-3">
                        <label for="task_parts" class="form-label">Parts</label>
                        <select class="form-select" id="task_parts" name="task_parts" multiple>
                            {% for part in parts %}
                                <option value="{{ part.id }}">{{ part.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="task_drawings" class="form-label">Drawings</label>
                        <select class="form-select" id="task_drawings" name="task_drawings" multiple>
                            {% for drawing in drawings %}
                                <option value="{{ drawing.id }}">{{ drawing.drw_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary mt-3">Submit</button>
        </form>
    </div>

    <script>
        function storeSolution() {
            const solutionSelect = document.getElementById('existing_solutions');
            const selectedOption = solutionSelect.options[solutionSelect.selectedIndex].text;
            localStorage.setItem('selectedSolution', selectedOption);
        }

        document.getElementById('task-tab').addEventListener('click', () => {
            const selectedSolution = localStorage.getItem('selectedSolution');
            const solutionNameDisplay = document.getElementById('selected-solution-name');
            if (selectedSolution) {
                solutionNameDisplay.textContent = `Selected Solution: ${selectedSolution}`;
                loadExistingTasks(selectedSolution);
            } else {
                solutionNameDisplay.textContent = 'No solution selected.';
            }
        });

        function loadExistingTasks(solutionName) {
            const existingTasks = [
                // Example tasks, replace with actual data from your backend
                { solution: 'Solution A', task: 'Inspect the equipment' },
                { solution: 'Solution B', task: 'Check the wiring' }
            ];

            const taskSelect = document.getElementById('existing_tasks');
            taskSelect.innerHTML = ''; // Clear existing options

            existingTasks
                .filter(task => task.solution === solutionName)
                .forEach(task => {
                    const option = document.createElement('option');
                    option.textContent = task.task;
                    taskSelect.appendChild(option);
                });
        }

        function addNewTask() {
            const taskDescription = document.getElementById('new_task_description').value;
            const newTaskContainer = document.getElementById('new-tasks-container');

            if (taskDescription.trim() === "") {
                alert("Task description cannot be empty.");
                return;
            }

            const taskElement = document.createElement('div');
            taskElement.className = 'alert alert-secondary';
            taskElement.textContent = taskDescription;
            newTaskContainer.appendChild(taskElement);

            // Clear the input field
            document.getElementById('new_task_description').value = '';
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<!-- Include pst_get_list_data.js -->
    <script src="{{ url_for('static', filename='js/pst_troubleshooting.js') }}"></script>
</body>
</html>
