# AggregateSearch Module Documentation

## Script Overview

**File**: `modules/search/aggregate_search.py`

**Purpose**: Comprehensive aggregated search system for an industrial maintenance chatbot that consolidates information from multiple database entities (Parts, Images, Positions, Equipment, etc.) into unified search results with contextual relationships.

**Core Functionality**:
- Provides unified search interface across multiple industrial database entities
- Aggregates related content (parts, images, positions, equipment) into comprehensive results
- Supports both legacy keyword-based search and modern NLP-enhanced search patterns
- Implements intelligent caching and fuzzy search fallbacks for robust performance
- Manages complex industrial equipment hierarchies and part associations

**Integration Context**: Part of a larger industrial maintenance system that includes:
- EMTAC database models for equipment, parts, and maintenance data
- NLP-enhanced search capabilities via SpaCy
- Pattern management system for flexible search queries
- Search analytics and query tracking

---

## Class: AggregateSearch

**Purpose**: Main search orchestrator that provides comprehensive, multi-entity search capabilities for industrial maintenance data.

**Key Responsibilities**:
- **Search Orchestration**: Coordinates searches across Parts, Images, Positions, Equipment, and their associations
- **Result Aggregation**: Combines related data from multiple sources into unified, contextual search results
- **Caching Management**: Implements LRU cache for performance optimization of frequently accessed searches
- **Legacy Compatibility**: Maintains backward compatibility with existing keyword-based search system
- **Error Handling**: Provides graceful degradation when database models or connections are unavailable

**Core Features**:
- **Multi-Entity Search**: Searches across Images, Parts, Positions, Areas, Equipment Groups, Models, and Locations
- **Association Discovery**: Finds and aggregates relationships between entities (e.g., parts used in specific equipment)
- **Hierarchical Search**: Supports equipment hierarchy navigation (Area → Equipment Group → Model → Position)
- **Intelligent Enhancement**: Enriches basic search results with related images, usage contexts, and cross-references
- **Fuzzy Matching**: Provides fallback search using fuzzy string matching for typos and variations

**Search Methods**:

### `comprehensive_image_search(params)`
**Purpose**: Aggregated image search that finds images with comprehensive contextual information from multiple association paths.

**Features**:
- Hierarchy-based filtering (area, equipment, model, location)
- Association searches (tools, tasks, problems, documents)
- Multi-path result aggregation with source tracking
- Enhanced result formatting with relationship context

### `comprehensive_part_search(params)`
**Purpose**: Ultimate part search system combining exact matching, manufacturer detection, and fuzzy fallbacks.

**Features**:
- **Dual Part Number Detection**: Distinguishes between company part numbers vs. manufacturer part numbers
- **Enhanced Pattern Recognition**: Identifies part numbers, manufacturer names, and equipment types from natural language
- **Fuzzy Search Fallback**: Provides intelligent fallback for typos and variations using fuzzy string matching
- **SQL Fallback**: Robust fallback to raw SQL when ORM methods fail
- **Relationship Enhancement**: Enriches part results with usage locations, associated images, and equipment context
- **Confidence Scoring**: Provides confidence levels for search matches and detection methods

### `comprehensive_position_search(params)`
**Purpose**: Hierarchical position search that aggregates all content (parts, images) found at specific equipment positions.

**Features**:
- Position hierarchy navigation and filtering
- Parts and images aggregation at each position
- Cross-reference discovery between positions and related content
- Equipment context aggregation with usage statistics

### `comprehensive_search_by_similarity(params)`
**Purpose**: AI-powered visual similarity search using pgvector embeddings for finding visually similar maintenance images.

**Features**:
- Reference image-based similarity search
- Configurable similarity thresholds
- pgvector embedding-based matching
- Enhanced results with comprehensive context

**Helper Methods**:

### `_enhance_part_result(part)`
**Purpose**: Enriches basic part data with related positions, images, and usage context.

### `_enhance_position_result(position)`
**Purpose**: Enhances position data with associated parts, images, and hierarchical context.

### `_enhance_image_result(result)`
**Purpose**: Adds comprehensive association context to image search results.

**Advanced Features**:

### Part Number Detection System
- **Company vs. Manufacturer Detection**: Intelligently distinguishes between internal part numbers and manufacturer part numbers
- **Pattern Recognition**: Uses regex patterns and database validation to identify part numbers in natural language
- **Fuzzy Matching**: Implements sophisticated fuzzy search across part numbers, manufacturer names, and equipment types
- **Confidence Scoring**: Provides reliability scores for different types of matches

### Search Strategy Selection
- **Priority-Based Matching**: Prioritizes company parts → manufacturer parts → manufacturer+equipment → manufacturer only → equipment only
- **Multi-Strategy Fallback**: Automatically falls back through different search strategies if primary methods fail
- **Database Validation**: Validates detected terms against actual database content before classification

**Legacy Compatibility**:
- **Keyword Management**: Maintains support for legacy keyword-action system
- **Pattern Matching**: Supports flexible pattern extraction with parameter substitution
- **Backward Compatibility**: Ensures existing search functionality continues to work while providing enhanced capabilities

**Performance Features**:
- **Intelligent Caching**: LRU cache with configurable limits for frequently accessed searches
- **Graceful Degradation**: Continues operation with reduced functionality when dependencies are unavailable
- **Connection Management**: Proper database session management with context manager support
- **Error Recovery**: Comprehensive error handling with informative fallback responses

**Integration Points**:
- **NLP Enhancement**: Designed to work with SpaCyEnhancedAggregateSearch for advanced natural language understanding
- **Pattern Management**: Integrates with SearchPatternManager for modern pattern-based search configuration
- **Analytics Integration**: Supports search query tracking and analytics collection
- **Database Models**: Tightly integrated with EMTAC database models and association tables

**Usage Context**: This class serves as the core search engine for an industrial maintenance chatbot, providing maintenance technicians with comprehensive, contextual search results that help them find parts, images, equipment information, and related documentation efficiently across complex industrial systems.